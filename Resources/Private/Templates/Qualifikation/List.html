{namespace tv = Pmwebdesign\Staffm\ViewHelpers}
<f:layout name="Default" />
<f:section name="main">
    <h1><f:translate id="staffm.qualifikation.list.headline" /></h1>
<f:flashMessages />
    <f:if condition="{key} == ''">  
        <f:then>
            <f:form action="list" arguments="{mitarbeiter:mitarbeiter, key:key, berechtigung:berechtigung, cache: '{cache}'}" additionalAttributes="{role: 'form'}">                                  
                <tv:widget.atoZNav objects="{qualifikations}" as="filteredQualifikations" property="bezeichnung" search="{search}" maid="{maid}"> 
                    <div class="input-group">
                        <div class="input-group-prepend">
                            <f:security.ifHasRole role="PA">                                                           
                                <f:link.action class="btn btn-default" title="Neue Qualifikation anlegen" action="new"><f:translate id="staffm.qualifikation.new" /></f:link.action>                               
                            </f:security.ifHasRole>
                            <f:link.action title="Die Liste in Excel ausgeben" id="excelExport" class="btn btn-default" action="export" arguments="{searching:'{search}'}" >
                                <f:image class="tx_staffm icon" src="typo3conf/ext/staffm/Resources/Public/Icons/Excel.png" />
                                Excel Export
                            </f:link.action>
                        </div>
                        <f:form.textfield class="form-control" placeholder="Suchwort..." title="Volltextsuche für Bezeichnung, oder einen Teil der Beschreibung einer Qualifikation" name="search" value="{search}" />                                                            
                        <div class="input-group-append">   
                            <button type="submit" class="btn btn-default"><f:translate id="staffm.search" /></button>
                        </div>                            
                    </div>
                    <tv:widget.sort objects="{filteredQualifikations}" as="sortedQualifikations" property="bezeichnung">
                   
                    <table class="tx_staffm" >
                            <tr>
                                <th><f:translate key="tx_staffm_domain_model_qualifikation.bezeichnung" /></th>  
                                <th><f:translate key="tx_staffm_domain_model_qualifikation.beschreibung" /></th>
                                <th class="staffmmobilehidden"><f:translate id="staffm.text.zugeordnete" /> <f:translate key="tx_staffm_domain_model_mitarbeiter" /></th>                                
                            </tr>
                            <f:for each="{sortedQualifikations}" as="qualifikation">
                                    <tr>
                                        <td><div id="q{qualifikation.uid}" class="anchor"></div><div class="tx_staffm tds250"><f:link.action title="{qualifikation.bezeichnung}" action="show" arguments="{qualifikation : qualifikation, search:search}">{qualifikation.bezeichnung}</f:link.action></div></td>
                                        <td><div class="tx_staffm tds400"><f:link.action title="{qualifikation.beschreibung}" action="show" arguments="{qualifikation : qualifikation, search:search}">{qualifikation.beschreibung}</f:link.action></div></td>                                                                                   
                                        <td class="staffmmobilehidden">     
                                            <f:for each="{qualifikation.employeequalifications}" as="m" iteration="iteration" reverse="TRUE">
                                                <f:if condition="{iteration.isFirst}">
                                                    <f:then>
                                                        <p class="marksq" title="{m.employee.telephone}"><f:link.action action="show" arguments="{qualifikation : qualifikation, search:search}"><span>{m.employee.lastName} {m.employee.firstName} ({m.status})</span></f:link.action>
                                                            <f:if condition="{qualifikation.employeequalifications -> f:count()} > 1">
                                                                <a class="btn btn-secondary btn-sm" style="float:right" href="javascript:void(0)" id="q{qualifikation.uid}" onClick="getID(this);return false;"><span name="q{qualifikation.uid}glyphiconchange" id="q{qualifikation.uid}" class="glyphicon glyphicon-triangle-bottom" aria-hidden="true"></span>
                                                                    <f:if condition="{qualifikation.employeequalifications -> f:count()} < 10">
                                                                        0
                                                                    </f:if>
                                                                    {qualifikation.employeequalifications -> f:count()}</a>
                                                            </f:if>
                                                        </p>
                                                    </f:then>
                                                    <f:else>
                                                        <p class="marksq q{qualifikation.uid}hidden" style="display:none" title="{m.employee.telephone}"><f:link.action action="show" arguments="{qualifikation : qualifikation, search:search}">{m.employee.lastName} {m.employee.firstName} ({m.status})</f:link.action></p>                                            
                                                    </f:else>
                                                </f:if>                                            
                                            </f:for>
                                        </td>                                         
                                        <f:security.ifHasRole role="PA">
                                            <td class="staffmmobilehidden nobackground">
                                                <div class="btn-group">
                                                    <f:link.action class="btn btn-secondary btn-sm" action="edit" arguments="{qualifikation : qualifikation}"><f:translate id="staffm.edit" /></f:link.action>
                                                    <f:link.action class="btn btn-danger btn-sm" action="delete" arguments="{qualifikation : qualifikation}"><f:translate id="staffm.delete" /></f:link.action>
                                                </div>
                                            </td>
                                        </f:security.ifHasRole>
                                    </tr>
                            </f:for>
                    </table>
                    </tv:widget.sort>
                </tv:widget.atoZNav>
            </f:form>
        </f:then>
        <f:else>
            <f:comment><!-- Qualification selection for the employee --></f:comment>
            <f:form action="update" controller="Mitarbeiter" arguments="{mitarbeiter:mitarbeiter, key:key, berechtigung:berechtigung}" additionalAttributes="{role: 'form'}" >  
                <table>
                    <td class="tx-staffm bold">Name:&nbsp;</td><td>{mitarbeiter.LastName} {mitarbeiter.firstName}</td><br />
                </table>            
                <table  class="tx_staffm" >
                    <tr>                        
                        <th><f:translate key="tx_staffm_domain_model_qualifikation.bezeichnung" /></th> 
                        <th><f:translate id="staffm.active" /></th>
                        <th><f:translate key="tx_staffm_domain_model_employeequalification.status" /></th>
                        <th><f:translate key="tx_staffm_domain_model_employeequalification.note" /></th>
                    </tr>
                    <f:for each="{qualifikations}" as="qualifikation">
                        <tr>                            
                            <f:if condition="{tv:quali(m:mitarbeiter, qu: qualifikation)} > 0">
                                <f:then>                       
                                    <td class="td{qualifikation.uid}" style="background-color: red">{qualifikation.bezeichnung}</td>                                         
                                    <td class="td{qualifikation.uid}" style="background-color: red"><f:form.checkbox id="qualiCheck{qualifikation.uid}" additionalAttributes="{onClick:'setCheckbox(this);'}" name="qualifikationen" value="{qualifikation.uid}" multiple="1" checked="1" /></td>                                 
                                    <td class="td{qualifikation.uid}" style="background-color: red"><f:form.select id="qualiSelect{qualifikation.uid}" name="qualificationsstatus[{qualifikation.uid}]" options="{qualifikation.status}" value="{tv:qualiStatus(mitarbeiter:mitarbeiter, qualifikation:qualifikation)}" /></td>                                 
                                    <td class="td{qualifikation.uid}" style="background-color: red"><f:form.textarea id="qualiText{qualifikation.uid}" name="qualificationsnotes[{qualifikation.uid}]" value="{tv:qualiNote(mitarbeiter:mitarbeiter, qualifikation:qualifikation)}" /></td>                                 
                                </f:then>
                                <f:else>
                                    <td class="td{qualifikation.uid}">{qualifikation.bezeichnung}</td>                                         
                                    <td class="td{qualifikation.uid}"><f:form.checkbox id="qualiCheck{qualifikation.uid}" additionalAttributes="{onClick:'setCheckbox(this);'}" name="qualifikationen" value="{qualifikation.uid}" multiple="1" checked="0" /></td>                                 
                                    <td class="td{qualifikation.uid}"><f:form.select id="qualiSelect{qualifikation.uid}" name="qualificationsstatus[{qualifikation.uid}]" options="{qualifikation.status}" value="" disabled="TRUE" /></td>
                                    <td class="td{qualifikation.uid}"><f:form.textarea id="qualiText{qualifikation.uid}" name="qualificationsnotes[{qualifikation.uid}]" value="" disabled="TRUE" /></td>
                                </f:else>
                            </f:if>
                        </tr>
                    </f:for>
                </table>
                <br />
                <div class="btn-group" role="group">
                    <f:link.action class="btn btn-secondary" action="edit" controller="Mitarbeiter" arguments="{mitarbeiter:mitarbeiter, berechtigung:berechtigung}"><f:translate id="staffm.back" /></f:link.action>
                    <button class="btn btn-success" type="submit"><f:translate id="staffm.choose" /> <f:translate id="staffm.text.uebergeben" /></button><!--<f:form.submit class="btn btn-default" value="Auswahl übergeben" />-->
                </div>
            </f:form>
        </f:else>
    </f:if>  
    <script>    
        function getID(stat) { 
            var id = stat.id;      

            // Klassen der Mitarbeiterqualifikation ermitteln
            var list = document.getElementsByClassName(id + "hidden");
            // Aus- oder einblenden
            for(var i = 0; i < list.length; i++) {
                /*(list[i].style.display == 'none') ? list[i].style.display = ''
                : list[i].style.display = 'none';*/

                var elem = document.getElementsByName(id + 'glyphiconchange');            
                if (list[i].style.display == 'none') {
                    list[i].style.display = '';
                    for (var ii = 0; ii < elem.length; ii++) { 
                        elem[ii].setAttribute('class', 'glyphicon glyphicon-triangle-top');
                    }                 
                } else {
                    list[i].style.display = 'none';
                    //elem.setAttribute('class', 'glyphicon glyphicon-triangle-bottom');
                    for (var ii = 0; ii < elem.length; ii++) { 
                        elem[ii].setAttribute('class', 'glyphicon glyphicon-triangle-bottom');
                    }        

                } 
            }    
            
        }
        /**
         * Checkbox 
         * Set/unset checkboxes and enable/disable fields
         * 
         * @param string stat
         * @return void
         */
        function setCheckbox(stat) {
            var wholeid = stat.id;
            var id = wholeid.substring(10);         
            var cb = document.getElementById(wholeid);
            var elem = document.getElementsByClassName("td" + id);
            var elemSelect = document.getElementById("qualiSelect" + id);
            var elemText = document.getElementById("qualiText" + id)
            
            if (cb.checked === true) {
                cb.checked = true;                
                for (var i = 0; i < elem.length; i++) {
                    elem[i].style.backgroundColor = "red";                    
                }
                elemSelect.disabled = false;
                elemSelect.value = 1;
                elemText.disabled = false;
            } else {
                cb.checked = false;
                for (var i = 0; i < elem.length; i++) {
                   
                    elem[i].style.backgroundColor = ""; 
                }
                elemSelect.disabled = true;
                elemSelect.value = "";
                elemText.disabled = true;
                elemText.value = "";
            }
        }
    </script>
</f:section>